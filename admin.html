<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administraci√≥n - √Årbol Geneal√≥gico</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>

  <h1>Panel de Administraci√≥n</h1>

  <button onclick="location.href='index.html'">Volver a la vista p√∫blica</button>

  <h2>A√±adir / Editar Miembro</h2>

  <form id="memberForm">
    <input type="hidden" id="memberId">

    <label>Nombre</label>
    <input type="text" id="nombre" required>

    <label>Apellidos</label>
    <input type="text" id="apellidos" required>

    <label>Pa√≠s de nacimiento</label>
    <input type="text" id="paisNac">

    <label>Lugar de nacimiento</label>
    <input type="text" id="lugarNac">

    <label>A√±o de nacimiento</label>
    <input type="number" id="anioNac">

    <label>A√±o de fallecimiento</label>
    <input type="number" id="anioFall">

    <label>Lugar de fallecimiento</label>
    <input type="text" id="lugarFall">

    <label>Padre (ID)</label>
    <input type="text" id="padre">

    <label>Madre (ID)</label>
    <input type="text" id="madre">

    <label>
      <input type="checkbox" id="hasPhoto"> Tiene fotograf√≠a
    </label>

    <button type="submit">Guardar</button>
  </form>

  <h2>Miembros Registrados</h2>
  <div id="memberList"></div>

  <hr>

  <h2>üì∏ Verificaci√≥n de fotograf√≠as</h2>
  <button onclick="checkMissingPhotos()">Detectar fotos faltantes</button>

  <pre id="photoLog"></pre>


  <!-- Firebase -->
  <script src="firebase.js"></script>

  <!-- Admin logic -->
  <script>
    // ================================
    // CARGAR MIEMBROS
    // ================================
    async function loadMembers() {
      const container = document.getElementById("memberList");
      container.innerHTML = "Cargando...";

      const snapshot = await db.collection("members").get();

      let html = "<ul>";
      snapshot.forEach(doc => {
        const m = doc.data();
        html += `<li>
          <b>${m.nombre} ${m.apellidos}</b> (ID: ${doc.id})
          <button onclick="editMember('${doc.id}')">Editar</button>
          <button onclick="deleteMember('${doc.id}')">Eliminar</button>
        </li>`;
      });
      html += "</ul>";

      container.innerHTML = html;
    }

    loadMembers();


    // ================================
    // GUARDAR MIEMBRO
    // ================================
    document.getElementById("memberForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const id = document.getElementById("memberId").value;
      const data = {
        nombre: document.getElementById("nombre").value,
        apellidos: document.getElementById("apellidos").value,
        paisNac: document.getElementById("paisNac").value,
        lugarNac: document.getElementById("lugarNac").value,
        anioNac: parseInt(document.getElementById("anioNac").value),
        anioFall: parseInt(document.getElementById("anioFall").value),
        lugarFall: document.getElementById("lugarFall").value,
        padre: document.getElementById("padre").value || null,
        madre: document.getElementById("madre").value || null,
        hasPhoto: document.getElementById("hasPhoto").checked
      };

      if (id) {
        await db.collection("members").doc(id).update(data);
      } else {
        await db.collection("members").add(data);
      }

      alert("Guardado correctamente");
      document.getElementById("memberForm").reset();
      document.getElementById("memberId").value = "";

      loadMembers();
    });


    // ================================
    // EDITAR MIEMBRO
    // ================================
    async function editMember(id) {
      const doc = await db.collection("members").doc(id).get();
      const m = doc.data();

      document.getElementById("memberId").value = id;
      document.getElementById("nombre").value = m.nombre;
      document.getElementById("apellidos").value = m.apellidos;
      document.getElementById("paisNac").value = m.paisNac;
      document.getElementById("lugarNac").value = m.lugarNac;
      document.getElementById("anioNac").value = m.anioNac;
      document.getElementById("anioFall").value = m.anioFall;
      document.getElementById("lugarFall").value = m.lugarFall;
      document.getElementById("padre").value = m.padre;
      document.getElementById("madre").value = m.madre;
      document.getElementById("hasPhoto").checked = m.hasPhoto;

      window.scrollTo(0, 0);
    }


    // ================================
    // ELIMINAR MIEMBRO
    // ================================
    async function deleteMember(id) {
      if (confirm("¬øSeguro que quieres eliminar este miembro?")) {
        await db.collection("members").doc(id).delete();
        loadMembers();
      }
    }


    // ================================
    // üîç VERIFICAR FOTOS FALTANTES
    // ================================
    async function checkMissingPhotos() {
      const log = document.getElementById("photoLog");
      log.textContent = "Comprobando...";

      const imgDir = "img/";

      const membersSnapshot = await db.collection("members").get();
      const members = membersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const missing = [];

      for (const m of members) {
        if (m.hasPhoto) {

          const fileName =
            `${m.nombre.replace(/ /g, "_")}_${m.apellidos.replace(/ /g, "_")}.jpg`
              .toLowerCase();

          const imagePath = `${imgDir}${fileName}`;

          try {
            const res = await fetch(imagePath, { method: "HEAD" });
            if (!res.ok) missing.push({ name: `${m.nombre} ${m.apellidos}`, fileName });
          } catch (err) {
            missing.push({ name: `${m.nombre} ${m.apellidos}`, fileName });
          }
        }
      }

      if (missing.length === 0) {
        log.textContent = "‚úÖ Todas las fotograf√≠as est√°n presentes.";
      } else {
        log.textContent = "‚ö†Ô∏è Fotograf√≠as faltantes:\n\n" +
          missing.map(m => `‚û°Ô∏è Subir: ${m.fileName} (para ${m.name})`).join("\n");
      }
    }
  </script>

</body>
</html>
